---
title: ã€Vueã€‘æºç è§£æ
date: 2019-03-18 09:50:34
categories: Vue
tags: Vue
---

ç°åœ¨ä¸‰å¤§æ¡†æ¶é£èµ·äº‘æ¶Œï¼Œ `JQuery`è€å¤§å“¥çš„å…‰è¾‰ä¸å†ï¼Œ ä½¿å‰ç«¯æˆä¸ºäº†å„è·¯è¯¸ä¾¯çš„å…µå®¶å¿…äº‰ä¹‹åœ°ï¼Œ 

å½“ç„¶ä½œä¸ºä¸€åä¼˜è´¨çš„å‰ç«¯ï¼Œå…‰è·Ÿé£å­¦æ¡†æ¶æ˜¯è‚¯å®šä¸è¡Œçš„ï¼Œ è¦çŸ¥å…¶ç„¶è€ŒçŸ¥å…¶æ‰€ä»¥ç„¶

è¦äº†è§£`MVVM`çš„æœ¬è´¨åŸç†ï¼Œ `virtual Dom`å’Œ `Diff`ç®—æ³•è§£å†³çš„é—®é¢˜

æ‹’ç»ç›²ç›®è·Ÿé£


## ğŸdiffDomä¼˜åŠ£
ç°åœ¨å¾ˆå¤šäººéƒ½è¯´ `Vue`, `React` å¤šç‰›ï¼Œ `Diff`ç®—æ³•å¿«ï¼Œä¸ç”¨æ“ä½œ`Dom`ã€‚

åªèƒ½æ— è¯­ã€‚

`Diff`ç®—æ³•ä¸æ˜¯ä¸éœ€è¦æ“ä½œ`Dom`,  è€Œæ˜¯ä¸éœ€è¦å¼€å‘è€…å»æ“ä½œ`Dom`äº†ï¼Œ `Diff`ç®—æ³•å…¶å®ä¸å¿«ï¼Œ å°±ç®—ä½¿ç”¨äº†`virtual Dom`,  è¿˜å¾—èŠ±å®ç°æŠŠçœŸå®`Dom` è½¬æ¢ä¸º `virtual Dom` å†å»æ¯”å¯¹ï¼Œ è¿™è¿œè¿œæ²¡æœ‰`js`ç›´æ¥ `getElementById`ç›´è¾¾ç›®æ ‡æ¥çš„å¿«

é‚£Diffç®—æ³•ä¸å¿«ä¸ºä»€ä¹ˆè¿˜è¦ç”¨å‘¢?

`Diff`ç®—æ³•å…¶å®æ˜¯ç»™é‚£äº›æ¯”è¾ƒéšæ„çš„æ–°æ‰‹å¼€å‘è€…å‡†å¤‡çš„

çœ‹è¿™ä¸ªä¾‹å­

```HTML
<!-- åŸæœ¬çš„dom -->
<ul id="ul">
  <li>a</li>
  <li>a</li>
  <li>a</li>
</ul>
```
```JavaScript
// æ‹¿åˆ°ç»“æœä¸ç®¡ä¸‰ä¸ƒäºŒåä¸€æŠŠæ—§domå…¨æ›¿æ¢äº†
$.get('/api', (res) => {
  var _HTML = ""
  for(var i=0; i< res.length; i++){
    _HTML = "<li>" + res[i] +"</li>"
  }
  $("#ul").html(_HTML)
})
```

å¦‚æœæ˜¯åŸå§‹çš„`Dom`æ“ä½œï¼Œ æœ‰å¾ˆå¤šå°ç™½ä¼šåƒè¿™ä¸ªä¾‹å­ä¸€æ ·ï¼Œ ä¸ç®¡`Dom`éœ€ä¸éœ€è¦æ›´æ–°ï¼Œ ä»–éƒ½æŠŠ`ajax`è¿”å›çš„è¯·æ±‚å…¨éƒ¨è·‘ä¸€è¾¹ï¼Œç”Ÿæˆ`HTML`æ¨¡æ¿ï¼Œ ç„¶åæŠŠåŸæœ¬çš„æ‰€æœ‰`li`éƒ½åˆ äº†ï¼Œ  å†æŠŠæ–°çš„æ¨¡æ¿æ”¾è¿›å»ï¼Œ `Dom`å°‘è¿˜çœ‹ä¸å‡ºæ¥ï¼Œ å¦‚æœ`Dom`å¤šäº†å‘¢ï¼Œ ä¸Šåƒçš„`Dom`ï¼Œ è¿™é¡¿æ“ä½œä¸€ä¸‹å°±ç©ç‚¸äº†ã€‚

å†µä¸”ç½‘ç«™ä¼˜åŒ–åŸåˆ™å°±æ˜¯å°½é‡å‡å°`Dom`æ“ä½œï¼Œ å¦‚æœæ˜¯æœ‰ç»éªŒçš„å¼€å‘è€…ï¼Œ ä¼šé€‰æ‹©æ‰¾åˆ°æœ‰å˜åŒ–çš„ä½ç½®ï¼Œä½¿ç”¨`append`æ’å…¥



## ğŸ“„Vueæ¶æ„ç›®å½•
å»[Vueå®˜ç½‘](https://github.com/vuejs/vue)ä¸‹è½½`Vue`æºç çœ‹çœ‹ï¼Œ

æ‰“å¼€é‡Œé¢ä¼šæœ‰ä¸€ä¸ª `src`ç›®å½•ï¼Œ é‡Œé¢å°±æ˜¯æ•´ä¸ªçš„`Vue`æºç 

ç›®å‰æœ‰6ä¸ªç›®å½•ï¼Œ ä½œç”¨åˆ†åˆ«å¦‚ä¸‹

![Vueç›®å½•](http://img.nixiaolei.com/2019-03-30-10-44-35.png)


`Vue.js` çš„ç»„æˆæ˜¯ç”± `core` + å¯¹åº”çš„ 'å¹³å°' è¡¥å……ä»£ç æ„æˆï¼ˆç‹¬ç«‹æ„å»ºå’Œè¿è¡Œæ—¶æ„å»ºåªæ˜¯ `platforms` ä¸‹ `web` å¹³å°çš„ä¸¤ç§é€‰æ‹©ï¼‰

`Vue`çš„æ ¸å¿ƒåŸç†å°±åœ¨`core`æ–‡ä»¶å¤¹ä¸­ï¼Œ è®©æˆ‘ä»¬è¿›å…¥ `core` æ–‡ä»¶å¤¹çœ‹çœ‹

![coreæ–‡ä»¶å¤¹](http://img.nixiaolei.com/2019-03-30-10-57-26.png)

äº†è§£äº†ç›®å½•ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±æ¥ç ”ç©¶`Vue`çš„åŒå‘ç»‘å®š

## ğŸ”—åŒå‘ç»‘å®šï¼ˆå“åº”å¼åŸç†ï¼‰ æ‰€æ¶‰åŠåˆ°çš„æŠ€æœ¯
* âœ… **Obejct.defineProperty** _ã€æä¾›getter å’Œ setterã€‘_
* âœ… **Observer** _ã€æä¾›getter å’Œ setterã€‘_
* âœ… **watcher**  _ã€æä¾›getter å’Œ setterã€‘_
* âœ… **Dep** _ã€è´Ÿè´£æ”¶é›†watcherã€‘_
* âœ… **Directive** _ã€å¤„ç†Vueæ¨¡æ¿æŒ‡ä»¤ã€‘_


### Obejct.defineProperty


`Obejct.defineProperty` æ˜¯æ•´ä¸ª`Vue`çš„çµé­‚ï¼Œ 

æ¥çœ‹ä¸€ä¸‹`Obejct.defineProperty` å¦‚ä½•ä½¿ç”¨
```JavaScript
var obj = {}
var c;
Object.defineProperty(obj, 'a', {
  get() {
    console.log('getter')
    return a
  },
  set(newVal) {
    console.log('setter')
    c = newVal
    this.a = newVal
  }
})

obj.a = '234'
console.log(c) // 234
console.log(obj.a) // 234
```


å®ƒå¸®åŠ©`Vue`å®ç°äº†åŒå‘ç»‘å®š, ä½†ä¹Ÿå› ä¸ºè¿™ä¸ªï¼Œ `Vue`ä¹Ÿåªèƒ½èˆå¼ƒäº†å¯¹ä½ç‰ˆæœ¬æµè§ˆå™¨çš„æ”¯æŒã€‚


![definePropertyå…¼å®¹](http://img.nixiaolei.com/2019-03-30-11-48-41.png)

å®ƒåªèƒ½å…¼å®¹åˆ°`IE9` ï¼Œ å¹¶ä¸”å¸‚é¢ä¸Šçš„`polyfill`å®ç°çš„ä¹Ÿå¹¶ä¸æ˜¯å¾ˆå¥½

é‚£ä½ç‰ˆæœ¬å¦‚ä½•ä»£æ›¿`Obejct.defineProperty` ï¼Œ éš¾é“çœŸæ²¡äº†å®ƒå°±ä¸è¡Œå—ï¼Ÿ


**å½“ç„¶æœ‰**ï¼š

1. ğŸ‘† > IE 7

å®é™…ä¸Šåœ¨`IE7`çš„æ—¶å€™å°±å·²ç»æœ‰æš´éœ²äº† `__defineGetter__` æ–¹æ³•ï¼Œ
![__defineGetter__](http://img.nixiaolei.com/2019-03-30-12-57-56.png)

å…·ä½“ç”¨æ³•å¦‚ä¸‹
```JavaScript
var random = {};
random.__defineGetter__('ten', function() { 
    return Math.floor(Math.random()*10); });
random.__defineGetter__('hundred', function() { 
    return Math.floor(Math.random()*100); });

random.ten // éšæœºçš„ä¸€ä¸ªå€¼
```

2.  ğŸ‘‡ < IE 7

æ—©å¹´é—´çš„`IE` æ˜¯æ”¯æŒ`VBScript`,  [VBScript](http://www.w3school.com.cn/vbscript/index.asp) å°±å¯ä»¥ç›´æ¥å†™ç±»ï¼Œ å¹¶ä¸”ä¹Ÿæ”¯æŒ`get`ï¼Œ`set`æ–¹æ³•

```JavaScript
class Test {
  get name () {
    
  }
  set name() {

  }
}
```

### ğŸ¶éœ¸é“çš„IE
è¯´äº†è¿™ä¹ˆå¤š`IE`çš„åï¼Œ è¿™é‡Œä¹Ÿå¸¦ä¸€å˜´`IE`çš„å¥½ï¼Œ

`IE`èƒ½å¤Ÿè°ƒç”¨`EXE`ç¨‹åº, æ¯”å¦‚`JS`æ— æ³•è®¾ç½®æ‰“å°æœºçš„å®½é«˜ï¼Œå°±å¯ä»¥åˆ©ç”¨`ActiveObjectX`æ¥åšåˆ°, ç”šè‡³å¯ä»¥ä¿®æ”¹`word`æ ¼å¼ç­‰ç­‰  , æ‰€ä»¥åŠå…¬ç±»çš„é¡¹ç›®ç¦»ä¸å¼€`IE`





## ğŸ˜•MVVM åŒå‘æ•°æ®ç»‘å®šæµç¨‹


MVVM: Modelâ€“viewâ€“viewmodel

é‚£æ€ä¹ˆåŒºåˆ†è¿™äº›å±‚å‘¢

* ğŸš€**Model**: `Observer`
* âœˆï¸**view** : `directive`
* ğŸšš**viewmodel**: `Watcher` && `Dep`  _ã€ç”¨äºè¿æ¥ Model å’Œ viewã€‘_


![åŒå‘æ•°æ®ç»‘å®š](http://img.nixiaolei.com/2019-03-30-11-51-42.png)



å…ˆçœ‹`Directive`, è¿™å°±æ˜¯æˆ‘ä»¬å¹³æ—¶å†™çš„`vue`æŒ‡ä»¤ï¼Œ å¦‚ä¸Šé¢ä¸¾ä¾‹å¾—çš„`v-text="times"`, è¿™å°±æ˜¯ä¸€ä¸ªæŒ‡ä»¤ï¼Œ ä¸€ä¸ª`Directive`ä¼šåˆ†é…ä¸€ä¸ª`Watcher`



### Observer

è§‚å¯Ÿè€…æ¨¡å¼æ˜¯è½¯ä»¶è®¾è®¡æ¨¡å¼çš„ä¸€ç§ã€‚åœ¨æ­¤ç§æ¨¡å¼ä¸­ï¼Œä¸€ä¸ªç›®æ ‡å¯¹è±¡ç®¡ç†æ‰€æœ‰ç›¸ä¾äºå®ƒçš„è§‚å¯Ÿè€…å¯¹è±¡ï¼Œå¹¶ä¸”åœ¨å®ƒæœ¬èº«çš„çŠ¶æ€æ”¹å˜æ—¶ä¸»åŠ¨å‘å‡ºé€šçŸ¥ã€‚è¿™é€šå¸¸é€è¿‡å‘¼å«å„è§‚å¯Ÿè€…æ‰€æä¾›çš„æ–¹æ³•æ¥å®ç°ã€‚æ­¤ç§æ¨¡å¼é€šå¸¸è¢«ç”¨æ¥å®æ—¶äº‹ä»¶å¤„ç†ç³»ç»Ÿã€‚è®¢é˜…è€…æ¨¡å¼æ¶‰åŠä¸‰ä¸ªå¯¹è±¡ï¼šå‘å¸ƒè€…ã€ä¸»é¢˜å¯¹è±¡ã€è®¢é˜…è€…ï¼Œä¸‰ä¸ªå¯¹è±¡é—´çš„æ˜¯ä¸€å¯¹å¤šçš„å…³ç³»ï¼Œæ¯å½“ä¸»é¢˜å¯¹è±¡çŠ¶æ€å‘ç”Ÿæ”¹å˜æ—¶ï¼Œå…¶ç›¸å…³ä¾èµ–å¯¹è±¡éƒ½ä¼šå¾—åˆ°é€šçŸ¥ï¼Œå¹¶è¢«è‡ªåŠ¨æ›´æ–°ã€‚

ç®€å•çš„æè¿°å°±æ˜¯:

ä½ æƒ³ä¹°æ¼«ç”»ï¼Œ ä½†æ˜¯é—®äº†æŠ¥åˆŠäº­çš„å¤§çˆ·ï¼Œ å¤§çˆ·è¯´ç°åœ¨æ²¡æœ‰ï¼Œ è¿˜æ²¡åˆ°è´§ï¼Œ ç„¶åä½ å›å»äº†ï¼Œ ç¬¬äºŒå¤©ä½ åˆå»é—®ï¼Œ å¤§çˆ·è¿˜æ˜¯è¯´æ²¡æœ‰ï¼Œ å¦‚æœä½ æ¯å¤©è¿™æ ·é—®ï¼Œ å¤§çˆ·ä¼°è®¡ä¼šå«Œä½ çƒ¦ã€‚ å¦‚æœè¿™æ—¶å€™ä½ æŠŠä½ çš„ç”µè¯ç»™å¤§çˆ·ï¼Œ å¤§çˆ·è®°å½•åˆ°ä»–çš„**æœ¬å­**ä¸Š,  å½“å¤§çˆ·çš„æ¼«ç”»åˆ°è´§çš„æ—¶å€™ç”µè¯é€šçŸ¥ä½ ã€‚

è¿™æ—¶ä½ å°±æ˜¯`è®¢é˜…è€…`, å¤§çˆ·å°±æ˜¯`å‘å¸ƒè€…`, ä½ ä»¬å°±å­˜åœ¨ä¸€ä¸ªå‘å¸ƒè®¢é˜…è€…çš„å…³ç³»



**Vue ä¸­çš„Observer**

Observerä¼šè§‚å¯Ÿä¸¤ç§ç±»å‹çš„æ•°æ®ï¼Œ`Object` ä¸ `Array`
å¯¹äº`Array`ç±»å‹çš„æ•°æ®ï¼Œç”±äº `JavaScript` çš„é™åˆ¶ï¼Œ `Vue` ä¸èƒ½æ£€æµ‹å˜åŒ–,ä¼šå…ˆé‡å†™æ“ä½œæ•°ç»„çš„åŸå‹æ–¹æ³•ï¼Œé‡å†™åèƒ½è¾¾åˆ°ä¸¤ä¸ªç›®çš„ï¼Œ

å½“æ•°ç»„å‘ç”Ÿå˜åŒ–æ—¶ï¼Œè§¦å‘ `notify` å¦‚æœæ˜¯ `push`ï¼Œ`unshift`ï¼Œ`splice` è¿™äº›æ·»åŠ æ–°å…ƒç´ çš„æ“ä½œï¼Œåˆ™ä¼šä½¿ç”¨`observer`è§‚å¯Ÿæ–°æ·»åŠ çš„æ•°æ®é‡å†™å®ŒåŸå‹æ–¹æ³•åï¼Œéå†æ‹¿åˆ°æ•°ç»„ä¸­çš„æ¯ä¸ªæ•°æ® ä½¿ç”¨`observer`è§‚å¯Ÿå®ƒè€Œå¯¹äº`Object`ç±»å‹çš„æ•°æ®ï¼Œåˆ™éå†å®ƒçš„æ¯ä¸ª`key`ï¼Œä½¿ç”¨ `defineProperty` è®¾ç½® `getter` å’Œ `setter`ï¼Œå½“è§¦å‘`getter`çš„æ—¶å€™ï¼Œ`observer`åˆ™å¼€å§‹æ”¶é›†ä¾èµ–ï¼Œè€Œè§¦å‘`setter`çš„æ—¶å€™ï¼Œ`observer`åˆ™è§¦å‘`notify`ã€‚


#### å¯¹ Object çš„å¤„ç†
`Observer` å¯¹è±¡çš„æ ‡å¿—å°±æ˜¯`__ob__` è¿™ä¸ªå±æ€§ï¼Œè¿™ä¸ªå±æ€§ä¿å­˜äº† `Observer` å¯¹è±¡è‡ªå·±æœ¬èº«ã€‚å¯¹è±¡åœ¨è½¬åŒ–ä¸º `Observer` å¯¹è±¡çš„è¿‡ç¨‹ä¸­æ˜¯ä¸€ä¸ªé€’å½’çš„è¿‡ç¨‹ï¼Œå¯¹è±¡çš„å­å…ƒç´ å¦‚æœæ˜¯å¯¹è±¡æˆ–æ•°ç»„çš„è¯ï¼Œä¹Ÿä¼šè½¬åŒ–ä¸º `Observer` å¯¹è±¡


#### å¯¹æ•°ç»„çš„å¤„ç†

å…¶å® `observeArray` æ–¹æ³•å°±æ˜¯å¯¹æ•°ç»„è¿›è¡Œéå†ï¼Œé€’å½’è°ƒç”¨ `observe` æ–¹æ³•ï¼Œæœ€ç»ˆéƒ½ä¼šèµ°å…¥ `walk` æ–¹ç›‘æ§å•ä¸ªå…ƒç´ ã€‚è€Œ `walk` æ–¹æ³•å°±æ˜¯éå†å¯¹è±¡ï¼Œç»“åˆ defineReactive æ–¹æ³•é€’å½’å°†å±æ€§è½¬åŒ–ä¸º `getter` å’Œ `setter`


### Watcher
`Watcher` æ˜¯å°†æ¨¡æ¿å’Œ `Observer` å¯¹è±¡ç»“åˆåœ¨ä¸€èµ·çš„çº½å¸¦ã€‚`Watcher` æ˜¯è®¢é˜…è€…æ¨¡å¼ä¸­çš„è®¢é˜…è€…ã€‚`Watcher` çš„ä¸¤ä¸ªå‚æ•°ï¼š `expOrFn` æœ€ç»ˆä¼šè¢«è½¬æ¢ä¸º `getter` å‡½æ•°ï¼Œ cb æ˜¯æ›´æ–°æ—¶æ‰§è¡Œçš„å›è°ƒã€‚ä¾èµ–æ”¶é›†çš„å…¥å£å°±æ˜¯getå‡½æ•°ã€‚

> getter å‡½æ•°æ˜¯ç”¨æ¥è¿æ¥ç›‘æ§å±æ€§ä¸ `Watcher` çš„å…³é”®


åªæœ‰é€šè¿‡`watcher` è§¦å‘çš„getter ä¼šæ”¶é›†ä¾èµ–ï¼Œè€Œæ‰€è°“çš„è¢«æ”¶é›†çš„ä¾èµ–å°±æ˜¯å½“å‰`watcher`.åˆå§‹åŒ–æ—¶ä¼ å…¥çš„å‚æ•° expOrFn ä¸­æ¶‰åŠåˆ°çš„æ¯ä¸€é¡¹æ•°æ®ï¼Œç„¶åè§¦å‘è¯¥æ•°æ®é¡¹çš„ getter å‡½æ•°ï¼›getter å‡½æ•°ä¸­å°±æ˜¯é€šè¿‡åˆ¤æ–­ Dep.targetçš„æœ‰æ— æ¥åˆ¤æ–­æ˜¯ `Watcher` åˆå§‹åŒ–æ—¶è°ƒç”¨çš„è¿˜æ˜¯æ™®é€šæ•°æ®è¯»å–ï¼Œå¦‚æœæœ‰åˆ™è¿›è¡Œä¾èµ–æ”¶é›†


### Dep

è¿™ä¸ªæ–¹æ³•æ˜¯åœ¨å“åº”å¼çš„è¿‡ç¨‹ä¸­è°ƒç”¨çš„ï¼Œç”¨æˆ·ä¿®æ”¹æ•°æ®è§¦å‘ setter å‡½æ•°ï¼Œå‡½æ•°çš„æœ€åä¸€è¡Œå°±æ˜¯è°ƒç”¨ dep.notify å»é€šçŸ¥è®¢é˜…è€…æ›´æ–°è§†å›¾ã€‚

### Directive

![Directive](http://img.nixiaolei.com/2019-03-30-14-50-38.png)


å…³äºç¼–è¯‘è¿™å—vueåˆ†äº†ä¸¤ç§ç±»å‹ï¼Œä¸€ç§æ˜¯æ–‡æœ¬èŠ‚ç‚¹ï¼Œä¸€ç§æ˜¯å…ƒç´ èŠ‚ç‚¹


vueå†…ç½®äº†è¿™ä¹ˆå¤šçš„æŒ‡ä»¤ï¼Œè¿™äº›æŒ‡ä»¤éƒ½ä¼šæŠ›å‡ºä¸¤ä¸ªæ¥å£bind å’Œ updateï¼Œè¿™ä¸¤ä¸ªæ¥å£çš„ä½œç”¨æ˜¯ï¼Œç¼–è¯‘çš„æœ€åä¸€æ­¥æ˜¯æ‰§è¡Œæ‰€æœ‰ç”¨åˆ°çš„æŒ‡ä»¤çš„bindæ–¹æ³•ï¼Œè€Œ update æ–¹æ³•åˆ™æ˜¯å½“watcher è§¦å‘ update æ—¶ï¼ŒDirectiveä¼šè§¦å‘æŒ‡ä»¤çš„updateæ–¹æ³•


observe -> è§¦å‘setter -> watcher -> è§¦å‘update -> Directive -> è§¦å‘update -> æŒ‡ä»¤





## ğŸ’¥æºç åˆ†æ
Vueçš„å®Œå…¨ç‰ˆæºç æœ‰å¾ˆå¤šåˆ¤æ–­ä»¥åŠå…¶ä»–çš„é€»è¾‘ï¼Œ å¯¹äºè§‚çœ‹æºç çš„äººï¼Œä¼šé€ æˆæå¤§çš„å›°éš¾ï¼Œ

å› æ­¤å‡†å¤‡äº†è¿™ç‰ˆä»¿ç…§Vueæµç¨‹å®ç°çš„ å®ç°äº†åŒå‘ç»‘å®šçš„[ç®€ç‰ˆVue](https://github.com/nxl3477/note/tree/master/Javascript/Vue/%E5%AE%9E%E7%8E%B0vue), æ–¹ä¾¿å­¦ä¹ ç†è§£

é€šè¿‡è¿™ç‰ˆå¯¹[Vueæºç çš„ç®€æ˜“ç¿»ç‰ˆ](https://github.com/nxl3477/note/tree/master/Javascript/Vue/%E5%AE%9E%E7%8E%B0vue)ï¼Œ æˆ‘ä»¬æ¥å¿«é€Ÿç†è§£VueåŸç†

### âœ¨ new Vue

é¦–å…ˆçœ‹ä¸€ä¸‹ï¼Œæˆ‘ä»¬çš„ new Vue, è¿™æ˜¯æ‰€æœ‰æ“ä½œçš„å…¥å£

```JavaScript
new Vue({
  data: {
    nickname: 'å¼ ä¸‰',
    email: "123123@qq.com"
  },
  el: '#app'
})
```
ç›¸ä¿¡ä½¿ç”¨è¿‡`Vue `çš„å°ä¼™ä¼´éƒ½æ˜ç™½ï¼Œ è¿™é‡Œå®šä¹‰äº†ä¸€ä¸ª`data`ï¼Œ ç”¨äºå­˜æ”¾å˜é‡ï¼Œ elæ˜¯ç›®æ ‡`dom`çš„é€‰æ‹©å™¨

### ğŸ”¥ new Vue æ‰§è¡Œæ—¶åšäº†ä»€ä¹ˆ

```JavaScript
function Vue(option) {
  var data = option.data 
  this.data = data
  // æŒ‚è½½ getter å’Œ setter
  observe(data, this)
  var id = option.el
  // ç¼–è¯‘ æ¨¡æ¿
  var dom = new Compile(document.querySelector(id), this)
  // æŠŠç¼–è¯‘å¥½çš„æ¨¡æ¿æŒ‚è½½åˆ° #app ä¸Š
  document.querySelector(id).appendChild(dom)
}
```

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œ Vueå…¶å®æ˜¯ä¸€ä¸ªæ„é€ å‡½æ•°ï¼Œ å®ƒæ¥æ”¶äº†ä¸€ä¸ªå‚æ•°`option`ï¼Œ è¿™ä¸ª`option`å°±æ˜¯æˆ‘ä»¬`new Vue`ä¼ å…¥çš„é‚£ä¸ªå¯¹è±¡
å› æ­¤æˆ‘ä»¬å¯ä»¥é€šè¿‡`option` æ‹¿åˆ°`data`å’Œ`el`ä¸¤ä¸ªå˜é‡ï¼Œ å½“ç„¶è¿™æ˜¯jsåŸºç¡€å“ˆï¼Œ æˆ‘å°±ä¸å†è¯´äº†

æ‹¿åˆ°`data`åï¼Œ æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å®ƒè°ƒç”¨äº†ä¸€ä¸ª `observe`æ–¹æ³•, å°†dataå’Œthisä¼ å…¥( æ­¤æ—¶thisæ—¶Vueå®ä¾‹ )

æ¥ä¸‹æ¥åˆæ ¹æ®`el`æ¥è·å–`dom`ï¼Œ åŒæ ·çš„å°†è·å–åˆ°çš„`dom`å’Œ`this`ä¼ å…¥äº† `Compile`ä¸­ï¼Œ  å¹¶ä¸”è¿˜æ¥æ”¶äº†ä¸€ä¸ªè¿”å›å€¼ï¼Œ ç„¶ååˆå°†è¿™ä¸ªè¿”å›å€¼æŒ‚åˆ°äº† `#app`ä¸Š

æ˜¯ä¸æ˜¯æ„Ÿè§‰ï¼Œ ä»€ä¹ˆé¬¼ï¼Ÿ, è¿™é¡¿æ“ä½œæ˜¯å•¥

é¦–å…ˆçœ‹ä¸€ä¸‹ç–‘æƒ‘çš„ `observe`ï¼Œ ä¼ å…¥äº† `data`ï¼Œ `this`, ç„¶åå°±æ²¡åŠ¨é™äº†ï¼Œ æ—¢ç„¶å¦‚æ­¤ï¼Œ æˆ‘ä»¬å°±è¿›å…¥`observe`çœ‹çœ‹

æ‰¾åˆ°`Observe`çš„æ„é€ å‡½æ•°
```JavaScript
function observe(obj, vm) {
  Object.keys(obj).forEach(key => {
    defineReactive(vm, key, obj[key])
  })
}
```
å¯ä»¥çœ‹åˆ°ï¼Œå®ƒæ¥æ”¶ä¸€ä¸ª`obj`å’Œ `vm`ï¼Œ å“¦ï¼Œ è¿™é‡Œå°±ä¸€ä¸€å¯¹åº”ä¸Šäº†ï¼Œ å°±æ˜¯æˆ‘ä»¬åˆšæ‰ä¼ å…¥çš„ `data`å’Œ`this` 

æ¥çœ‹çœ‹å®ƒåšäº†ä»€ä¹ˆï¼Œ 

å®ƒæŠŠ`obj`æšä¸¾äº†ä¸€éï¼Œ å¹¶å°†æ¯ä¸€æ¬¡çš„  `vm`, `key`,`value` éƒ½ä¼ å…¥ä¸€ä¸ªå« `defineReactive`çš„æ–¹æ³•


å¥½ï¼Œé‚£å°±è®©æ¥çœ‹`defineReactive`åšäº†ä»€ä¹ˆ

```JavaScript
function defineReactive(vm, key, val) {
  // ä¸ºæ¯ä¸ªå˜é‡åˆ†é…ä¸€ä¸ª depå®ä¾‹
  var dep = new Dep()
  // é…ç½®getterå’Œsetterå¹¶ä¸”æŒ‚è½½åˆ°vmä¸Š
  Object.defineProperty(vm, key, {
    get() {
      if ( Dep.target ) {
        // JSçš„æµè§ˆå™¨å•çº¿ç¨‹ç‰¹æ€§ï¼Œ ä¿è¯æ•´ä¸ªå…¨å±€å˜é‡åœ¨åŒä¸€æ—¶é—´å†…ï¼Œ åªæœ‰ä¸€ä¸ªç›‘å¬å™¨ä½¿ç”¨
        dep.addSub(Dep.target)
      }
      return val
    },
    set(newVal) {
      if ( newVal == val ) return;
      val = newVal;
      // ä½œä¸ºå‘å¸ƒè€…å‘å‡ºé€šçŸ¥
      dep.notify()
    }
  })
}
```

æˆ‘ä»¬çœ‹åˆ°ï¼Œ å®ƒ`new`äº†ä¸€ä¸ª`Dep`ï¼Œ è¿™ä¸ª`Dep`å°±æ˜¯æŠ¥åˆŠäº­å¤§çˆ·çš„ç”µè¯æœ¬ï¼Œ ç”¨æ¥æ”¶é›†æ‰€æœ‰æƒ³ä¹°æŠ¥çº¸æˆ–æ‚å¿—çš„äººçš„ç”µè¯ï¼Œ ç­‰åˆ°åˆ°è´§æ—¶å°±å¥½æŒ¨ä¸ªé€šçŸ¥

ç„¶åæˆ‘ä»¬çœ‹åˆ°äº†çµé­‚å‡½æ•° `Object.defineProperty`,  

å—·é‚£æˆ‘ä»¬åº”è¯¥å°±æ˜ç™½äº†ï¼Œ è¿™é‡Œçš„ä¸€é¡¿æ“ä½œå°±æ˜¯ä¸ºäº†ç»™`data`é‡Œçš„æ¯ä¸ªå±æ€§éƒ½æŒ‚è½½ä¸Š `getter`ï¼Œ`setter`, å¹¶ä¸”å°†è¿™äº›å±æ€§ç›´æ¥è½¬ç§»åˆ°äº†`vm`ä¸Šï¼ˆVueå®ä¾‹ï¼‰

é‚£æ—¢ç„¶å¦‚æ­¤ï¼Œ 

ğŸ¤ªè®©æˆ‘ä»¬çœ‹çœ‹ `getter`æ–¹æ³•åšäº†ä»€ä¹ˆï¼Œ 

é¦–å…ˆå®ƒåˆ¤æ–­äº†ä¸€ä¸‹`Dep.target`ï¼Œ  å¦‚æœ`Dep.target`ä¸º`true` , å°±è°ƒç”¨`dep`çš„`addSub`æ–¹æ³•ï¼Œ è¿™é‡Œ`Dep.target`æ˜¯å•¥æˆ‘ä»¬å…ˆä¸ç®¡ï¼Œ ç•™ä¸ªå°è±¡å³å¯

ç„¶åå®ƒç›´æ¥`return`äº†`val`

ğŸ˜µå†æ¥çœ‹çœ‹`setter`æ–¹æ³•

`setter`æ–¹æ³•æ¥æ”¶ä¸€ä¸ªæ–°å€¼ï¼Œ  é¦–å…ˆå°±æ˜¯åˆ¤æ–­äº†æ–°å€¼å’ŒåŸæœ¬çš„å€¼æ˜¯å¦ç›¸ç­‰ï¼Œ å¦‚æœç›¸ç­‰å°±ä¸åšå¤„ç†äº†ï¼Œ å¦‚æœä¸ç›¸ç­‰ï¼Œ å®ƒå°†æ–°å€¼èµ‹ç»™`val`

ç„¶åè°ƒç”¨`dep`å®ä¾‹ä¸Šçš„`notify`æ–¹æ³•ï¼Œ `notify` çœ‹ç€åå­—ä¹ŸçŸ¥é“æ˜¯é€šçŸ¥ï¼Œ ä¹Ÿå°±æ˜¯å¤§çˆ·æŒ¨ä¸ªæ‰“ç”µè¯çš„ä¸€ä¸ªæ“ä½œ


å¥½, è¿™ä¸€å—æˆ‘ä»¬ç†é¡ºäº†ï¼Œ æ˜¯ä¸ºäº†æŒ‚ä¸Š`getter`å’Œ`setter`ï¼Œ ä½†åˆé‡åˆ°äº†æ–°é—®é¢˜`dep`ï¼Œ `dep`åˆ°åº•åœ¨å¹²ä»€ä¹ˆï¼Œ ä¸ºä»€ä¹ˆè¢«`getter`ï¼Œ`setter`éƒ½ä½¿ç”¨äº† 


æ‰¾åˆ°`Dep`çš„æ„é€ å‡½æ•°
```JavaScript
function Dep() {
  // å­˜æ”¾watcher
  this.subs = []
}

Dep.prototype = {
  // æ·»åŠ watcher, ä¹Ÿå°±æ˜¯æ·»åŠ è®¢é˜…
  addSub(sub) {
    this.subs.push(sub)
  },
  // é€šçŸ¥æ‰€æœ‰watcher
  notify() {
    this.subs.forEach(sub => {
      sub.update()
    })
  }
}
```

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œ `Dep`æ„é€ å‡½æ•°ä¸­ç»´æŠ¤äº†ä¸€ä¸ª `subs`æ•°ç»„ï¼Œ å¹¶ä¸”ä¸‹é¢çš„åœ¨`prototype`ä¸Šå®šä¹‰äº†å‡ ä¸ªæ–¹æ³•ï¼Œ `addSub` å’Œ`notify`ï¼Œ
è¿™ä¸å°±æ˜¯åˆšåˆš`observe`é‡Œè°ƒç”¨çš„ä¸¤ä¸ªæ–¹æ³•å—ï¼Œ 
å“¦ï¼Œæ˜ç™½äº†ï¼Œ `addSub`åŸæ¥æ˜¯å°†`getter`ä¸­ä¼ å…¥çš„ `Dep.target`è¿½åŠ åˆ°æ¯ä¸ª`Dep`å®ä¾‹éƒ½å•ç‹¬ç»´æŠ¤çš„ä¸€ä¸ª`subs`æ•°ç»„ä¸­å‘€ï¼Œ `notify`å°±æ˜¯éå†æ•´ä¸ªæ•°ç»„ï¼ŒæŒ¨ä¸ªè°ƒç”¨`update`æ–¹æ³•ï¼ˆå…ˆä¸ç®¡updateçš„å…·ä½“å®ç°ï¼‰


å¥½ï¼Œ è§£å†³äº†`observe`æ–¹æ³•ï¼Œé‚£æˆ‘ä»¬å°±å›åˆ°æœ€åˆçš„`Vue`æ„é€ å‡½æ•°ä¸­,  ç»§ç»­å¾€ä¸‹èµ°, æ”»å…‹å‰©ä½™çš„ç»¿è‰²åŒºåŸŸ

![Compile](http://img.nixiaolei.com/2019-03-31-11-36-41.png)


æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå®ƒé€šè¿‡`el` è·å–åˆ°äº†`dom`, å¹¶åœ¨`new Compile` å°†`dom` ä¼ å…¥

é‚£æˆ‘ä»¬å°±æ‰¾åˆ°`Compile`çš„æ„é€ å‡½æ•°ä¸€æ¢ç©¶ç«Ÿ
```JavaScript
function Compile(node, vm) {
  if(node) {
    this.$frag = this.nodeToFragment(node, vm)
    return this.$frag
  }
}
```

å¯ä»¥çœ‹åˆ°ï¼Œ å®ƒæ¥æ”¶äº†ä¸€ä¸ª`node`ï¼Œ å’Œä¸€ä¸ª`vm` , å¹¶ä¸”åˆ¤æ–­äº†ä¸€ä¸‹`node`æ˜¯å¦å­˜åœ¨ï¼Œ 

å¹¶å°†`node`å’Œ`vm`ï¼Œä¼ å…¥äº†`this.nodeToFragment`æ–¹æ³•ï¼Œ åˆå°†å…¶çš„è¿”å›ç»“æœ`return`å‡ºå»ï¼Œ ä¹Ÿå°±æ˜¯`new Compile`ä¹‹åè¿”å›çš„å€¼ ï¼Œå¦‚ä¸‹

![Compile02](http://img.nixiaolei.com/2019-03-31-11-49-23.png)


é‚£`this.nodeToFragment`è¿™ä¸ªæ–¹æ³•åšäº†ä»€ä¹ˆï¼Œ è®©æˆ‘ä»¬æ‰¾åˆ°ä»–
```JavaScript
Compile.prototype = {
  nodeToFragment(node, vm) {
    var _this = this
    // åˆ›å»ºæ–‡æ¡£ç‰‡æ®µ
    var frag = document.createDocumentFragment()
    var child;
    while ( child = node.firstChild ) {
      // æ›¿æ¢å˜é‡
      _this.compileElement(child, vm)
      // å‰ªè´´å­å…ƒç´ 
      frag.append(child)
    }
    return frag
  },
  compileElement(node, vm) {
    var reg = /\{\{(.*)\}\}/;
    // èŠ‚ç‚¹ç±»å‹ä¸ºå…ƒç´ , æ ¹æ®nodeTypeæ¥åˆ¤æ–­
    if ( node.nodeType === 1 ) {
      // è·å–è‡ªå®šä¹‰å±æ€§
      var attr = node.attributes
      for (var i = 0; i < attr.length; i++) {
        if (attr[i].nodeName == "v-model") {
          // è·å–v-model ç»‘å®šçš„å±æ€§å
          var name = attr[i].nodeValue
          // åŒå‘ç»‘å®š
          node.addEventListener('input', function(e) {
            // ç»™ç›¸åº”çš„dataå±æ€§èµ‹å€¼ï¼Œ è¿›è€Œè§¦å‘è¯¥å±æ€§çš„setæ–¹æ³•
            // å†æ‰¹å¤„ç†æ¸²æŸ“å…ƒç´ 
            vm[name] = e.target.value 
          })
          // æŠŠthis ï¼ŒèŠ‚ç‚¹ï¼Œ è¿˜æœ‰v-modelç»‘å®šçš„å˜é‡äº¤ç»™watcher
          new Watcher(vm, node, name, "value")
        }
      }
    }

    // èŠ‚ç‚¹ç±»å‹ä¸ºtext
    if ( node.nodeType === 3 ) {
      if ( reg.test(node.nodeValue) ) {
        var name = RegExp.$1; // è·å–åŒ¹é…åˆ°çš„å­—ç¬¦ä¸²
        name = name.trim()
         // æŠŠthis ï¼ŒèŠ‚ç‚¹ï¼Œ è¿˜æœ‰{{}}ä¸­ä½¿ç”¨çš„å˜é‡äº¤ç»™watcher
        new Watcher(vm, node, name, 'nodeValue')
      }
    }
  }
}
```

æˆ‘ä»¬çœ‹åˆ°å®ƒåœ¨`Compile`åŸå‹ä¸ŠæŒ‚äº†`nodeToFragment`, `compileElement`ä¸¤ä¸ªæ–¹æ³•ï¼Œ  `nodeToFragment`æ–¹æ³•æ¥æ”¶ `node`, `vm`å‚æ•°

å…ˆä¿å­˜äº†ä¸€ä¸‹`this`æŒ‡å‘,  ç„¶åä½¿ç”¨`document.createDocumentFragment()`æ–¹æ³•åˆ›å»ºäº†ä¸€ä¸ªæ–‡æ¡£ç‰‡æ®µï¼Œ å¹¶å°†åœ¨`while`å¾ªç¯ä¸­ä¼ å…¥çš„`node`èŠ‚ç‚¹çš„ç¬¬ä¸€ä¸ªå…ƒç´ èµ‹å€¼ç»™ `child`å˜é‡ï¼Œ
ç„¶åä½¿ç”¨`compileElement(child, vm)` å°†`child`å’Œ`vm` ä¼ å…¥, ç„¶åå°†`child` è¿½åŠ ç»™åˆ›å»ºå¥½çš„æ–‡æ¡£ç‰‡æ®µ`frag`, ä½ è‚¯å®šä¼šè§‰å¾—è¿™æ˜¯ä¸ªæ­»å¾ªç¯, å…¶å®ä¸æ˜¯çš„ï¼Œ è¿™ä¸ª`append`å¯¹`dom`æœ‰å‰ªåˆ‡çš„æ•ˆæœï¼Œ
æ‰€ä»¥ä»–ä¼šä¸€ç›´æŠ½ç¦»`node`çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ï¼Œç›´è‡³`node`ç©ºäº†ï¼Œ å¸å¹²ä»–

å®Œæˆäº†è¿™é¡¿æ“ä½œåï¼Œ å†å°†`frag`æ–‡æ¡£ç‰‡æ®µè¿”å›

ç„¶åæˆ‘ä»¬æ¥çœ‹çœ‹å®ƒåœ¨`while`ä¸­è°ƒç”¨çš„`compileElement`æ–¹æ³•åšäº†ä»€ä¹ˆ

å®ƒåŒæ ·æ¥æ”¶`node`å’Œ`vm` , é¦–å…ˆå°±æ˜¯å®šä¹‰ä¸€ä¸ªæ­£åˆ™ï¼Œ è¿™æ˜¯ç”¨æ¥åŒ¹é…`{{}}`åŒæ‹¬å·çš„ï¼Œ ä¹Ÿå°±æ˜¯æˆ‘ä»¬å¹³æ—¶çš„å˜é‡å†™æ³•

ç„¶åå®ƒåˆ¤æ–­äº†ä¸€ä¸‹è¿™ä¸ª `node`çš„èŠ‚ç‚¹ç±»å‹,  å¦‚æœ`nodeType == 1`, é‚£å°±è¯´æ˜æ˜¯å…ƒç´ ï¼Œ  å¦‚æœ`nodeType == 3` é‚£å°±è¯´æ˜èŠ‚ç‚¹ç±»å‹æ˜¯`text`
      
å¦‚æœèŠ‚ç‚¹ç±»å‹æ˜¯å…ƒç´ ï¼Œ å°±åˆ©ç”¨`attributes` æ–¹æ³•ï¼Œè·å–åˆ°è¯¥å…ƒç´ èº«ä¸Šçš„å±æ€§,  æŸ¥çœ‹æ˜¯å¦å­˜åœ¨`v-model`è¿™æ ·ä¸€ä¸ªå±æ€§ï¼Œ å¦‚æœæœ‰ï¼Œå°±è·å–åˆ°`v-model`å¡«å†™çš„å˜é‡ï¼Œäº¤ç»™å˜é‡`name`,
ç„¶åç›‘å¬è¯¥å…ƒç´ çš„`input`äº‹ä»¶ï¼Œ 

æ‰€ä»¥æ¯å½“æ”¹å…ƒç´ å‘ç”Ÿ`input`æ—¶é—´æ—¶ï¼Œå°±å°†å…ƒç´ ä¸Šçš„`value`æ ¹æ®`v-model`ä¸Šè·å–åˆ°çš„`name`ä½œä¸º`vm`çš„`key`å»ä¿®æ”¹`vm`å®ä¾‹ä¸Šçš„å¯¹åº”çš„å€¼ï¼Œ å› ä¸º`vm`ä¸Šçš„å˜é‡å·²ç»è¢«æŒ‚è½½æ­¤æ¥è§¦å‘`vm`

æœ€åè¿˜åˆ›å»ºäº†ä¸€ä¸ª`Watcher`å®ä¾‹,  ä¼ å…¥`vm, node ,name, "value"`è¿™å‡ ä¸ªå‚æ•°ï¼Œ

`Watcher`çš„å…·ä½“å®ç°æˆ‘ä»¬å¾…ä¼šå»çœ‹

æ¥ä¸‹æ¥å°±æ˜¯åˆ¤æ–­`node.nodeType == 3`ï¼Œ ä¹Ÿå°±æ˜¯textç±»å‹çš„èŠ‚ç‚¹ï¼Œ å¦‚æœæ˜¯æ­¤ç±»èŠ‚ç‚¹ï¼Œ å°±å…ˆç”¨æ­£åˆ™å»åŒ¹é…ä¸€ä¸‹`{{}}`è¯­æ³•ï¼Œ çœ‹çœ‹æœ‰æ²¡æœ‰ä½¿ç”¨åˆ°æŸä¸ªå˜é‡ï¼Œ 
å¦‚æœåŒ¹é…åˆ°äº†ï¼Œ åˆ™é€šè¿‡`RegExp.$1`è·å–åˆ°è¢«åŒ¹é…åˆ°çš„å€¼ï¼Œ ç„¶åå»é™¤å·¦å³çš„ç©ºæ ¼ï¼Œ äº¤ç»™å˜é‡`name`
æœ€åï¼ŒåŒæ ·çš„åˆ›å»ºäº†ä¸€ä¸ª`Watcher`å®ä¾‹,  ä¼ å…¥`vm, node ,name, "value"`è¿™å‡ ä¸ªå‚æ•°ï¼Œ

å‡ºç°ä¸¤æ¬¡`Watcher`ï¼Œ ä»€ä¹ˆæƒ…å†µï¼Œ åˆ°åº•å¹²äº†å•¥
é‚£ï¼Œ ç°åœ¨å°±æ¥è®©æˆ‘ä»¬çœ‹çœ‹ç¥ç§˜çš„`Watcher`æ„é€ å‡½æ•°

æ‰¾åˆ°`Watcher`çš„æ„é€ å‡½æ•°
```JavaScript
let uid = 0;

function Watcher(vm, node, name, type) {
  // å•ä¾‹ï¼Œ ä½¿ç”¨åŸå› æœªçŸ¥
  Dep.target = this
  // å§“å
  this.name = name;
  // å‘µå‘µå“’ uid
  this.id = ++uid;
  // ä¸å˜é‡ç›¸å…³çš„NodeèŠ‚ç‚¹
  this.node = node;
  // vm å®ä¾‹
  this.vm = vm;
  // å˜é‡ç±»å‹  nodeValue  || value
  this.type = type;
  // è§¦å‘è‡ªå·±åŸå‹ä¸Šçš„updateæ–¹æ³•
  this.update()
  // Watcher å®ä¾‹åˆ›å»ºç»“æŸå°±æŠŠå•ä¾‹ç½®ç©º
  Dep.target = null
}
```

æ­¤æ—¶æˆ‘ä»¬å‘ç°äº†ä¸€ä¸ªå…³é”®çš„ä¸œè¥¿`Dep.target` ï¼Œ è¿™ä¸ªé¬¼ä¸œè¥¿åŸæ¥åœ¨è¿™é‡Œï¼Œ å®ƒè¢«èµ‹å€¼ä¸ºäº†`Watcher`çš„å®ä¾‹ï¼Œ ç„¶ååœ¨`Watcher`å®ä¾‹ä¸ŠæŒ‚è½½äº†`name`ï¼Œä¹Ÿå°±æ˜¯ç”¨åˆ°çš„å˜é‡ï¼Œ è¿˜ä½¿ç”¨äº†ä¸€ä¸ª`uid`ï¼Œ ä¸è¿‡è¿™`uid`ä¹Ÿæ˜¯å‘µå‘µäº†ï¼Œç”¨æ•°å­—ä½œä¸º`uid`, `Vue`çš„çœŸå®æºç å°±è¿™ä¹ˆå¹²çš„ï¼Œ ä¸ºæ¯ä¸ª`Watcher`éƒ½é…åˆ†ä¸€ä¸ª`uid`ï¼Œ è¿™ä¼šé€ æˆæ•°ç»„ç©ºé—´çš„ä¸è¿ç»­ï¼Œ å¼•å‘å†…å­˜æ³„æ¼

æ¥ç€è¯´ï¼Œ ç„¶åä»–å°†ä¼ å…¥çš„`node`èŠ‚ç‚¹ï¼Œ `vm`å®ä¾‹ï¼Œ è¿˜æœ‰`type`( 'nodeValue' å’Œ 'value' ), éƒ½æŒ‚åˆ°äº†å®ä¾‹ä¸Šé¢ï¼Œ å¹¶ä¸”è¿˜åœ¨è°ƒç”¨äº†`update`æ–¹æ³•åï¼Œ å°†`Dep.target`è®¾ä¸º`null`

é‚£æˆ‘ä»¬æ¥çœ‹ä¸‹`update`åšäº†å•¥

```JavaScript
Watcher.prototype = {
  update() {
    this.get()
    if(!batcher) {
      // bastcher å•ä¾‹
      batcher = new Batcher()
    }
    // åŠ å…¥é˜Ÿåˆ—
    batcher.push(this)
  },
  // è·å–æ–°å€¼æŒ‚åˆ°è‡ªå·±çš„å®ä¾‹ä¸Š
  get() {
    this.value = this.vm[this.name]  // è§¦å‘getter
  }
}
```

çœ‹åˆ°`update`æ–¹æ³•ï¼Œ é¦–å…ˆè°ƒç”¨äº†ä¸€ä¸‹`get`æ–¹æ³•ï¼Œ è¿™ä¸ª`get`å‘¢å°±æ˜¯æ ¹æ®`this.name`ä» `vm`å®ä¾‹ä¸Šå–ä¸€æ¬¡å€¼ï¼Œ å¹¶æŒ‚åˆ°`Watcher`å®ä¾‹ä¸Šçš„`value`å±æ€§ä¸Š, å¹¶ä¸”ä»–è¿˜ä¼šè§¦å‘ä¸€æ¬¡`getter`æ–¹æ³•ï¼Œå°†è‡ªå·±åŠ å…¥åˆ°`dep`ä¸­ï¼Œ ä¹Ÿå°±æ˜¯åŠ å…¥åˆ°æŠ¥åˆŠäº­å¤§çˆ·çš„ç”µè¯æœ¬ä¸­ï¼Œ ä¾¿äºä¹‹åçš„é€šçŸ¥

ç„¶ååˆ¤æ–­äº†ä¸€ä¸‹`window.batcher`æ˜¯å¦å­˜åœ¨ï¼Œ å¦‚æœä¸å­˜åœ¨å°±åˆ›å»ºä¸€ä¸ªï¼Œ ä¿è¯å…¶æ˜¯ä¸€ä¸ªå•ä¾‹æ¨¡å¼,
å¦‚æœå­˜åœ¨ï¼Œ å°±å°†è‡ªå·±(`watcher`å®ä¾‹)ï¼Œé€šè¿‡`push`æ–¹æ³•ä¼ å…¥

çœ‹åˆ°è¿™é‡Œï¼Œåˆæ™•äº†ï¼Œ ä»€ä¹ˆæ—¶å€™åˆå†’å‡ºæ¥ä¸€ä¸ª`Batcher`

æˆ‘ä»¬åˆæ‰¾åˆ°`Batcher`çš„æ„é€ å‡½æ•°å¥½å¥½åˆ†æä¸‹ï¼Œ
```JavaScript
// æ‰¹å¤„ç†æ„é€ å‡½æ•°
function Batcher() {
  //  é‡ç½®  has  queue waiting
  this.reset()
}

Batcher.prototype.reset = function () {
  this.has = {}
  this.queue = []
  this.waiting = false
} 

// å°†watcher æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­
Batcher.prototype.push = function (job) {
  let id = job.id
  // å…ˆæ ¹æ® å¯¹è±¡çš„key çœ‹çœ‹æ˜¯å¦å·²ç»æœ‰äº†è¿™ä¸ªwatcher
  if (!this.has[id]) {
    // console.log(batcher)
    this.queue.push(job)
    // å°†watcher çš„keyçš„è®¾ä¸ºtrue
    this.has[id] = true

    // å»¶è¿Ÿæ‰§è¡Œ
    if (!this.waiting ) {
      this.waiting = true
      if ( "Promise" in window ) {
        Promise.resolve().then(() => {
          this.flush()
        })
      } else {
        setTimeout(() => {
          this.flush()
        }, 0)
      }
    }
  }
}


// æ‰§è¡Œå¹¶æƒ…å†µäº‹ä»¶é˜Ÿåˆ—
Batcher.prototype.flush = function() {
  this.queue.forEach(job => {
    job.cb()
  })
  this.reset()
}


```

`Batcher`çš„æ„é€ å‡½æ•°å¾ˆç®€å•ï¼Œ å°±è°ƒç”¨äº†ä¸€ä¸‹è‡ªå·±çš„`reset`æ–¹æ³•ï¼Œ ä½†å¥½åƒäº‹æƒ…è¿œæ²¡æœ‰è¿™ä¹ˆç®€å•ï¼Œæˆ‘ä»¬ä¸æ˜¯åœ¨ `Watcher`çš„`update`æ–¹æ³•ä¸­è°ƒç”¨äº†`batcher.push`å—ï¼Œ æˆ‘ä¹Ÿå¯ä»¥åœ¨è¿™åŸå‹ä¸Šæ‰¾çš„è¿™ä¸ªæ–¹æ³•ï¼Œ é¦–å…ˆå®ƒæ¥æ”¶ä¸€ä¸ª`job`å‚æ•°ï¼Œ ä¹Ÿå°±æ˜¯`Watcher`å®ä¾‹ï¼Œ 

è·å–åˆ°è¯¥`watcher`çš„`id`, ç„¶åä½¿ç”¨è¿™ä¸ª`id`,å»`has`è¿™ä¸ªå¯¹è±¡ä¸Šè®¿é—®ä¸€ä¸‹ï¼Œ çœ‹çœ‹æ˜¯å¦å­˜åœ¨ï¼Œ
å¦‚æœä¸å­˜åœ¨ï¼Œåœ¨è¯æ˜ä¹‹å‰æ²¡æœ‰æ·»åŠ è¿›æ¥è¿‡ï¼Œ ç„¶åå°†è¯¥`watcher`å®ä¾‹åŠ åˆ°`queue`é˜Ÿåˆ—ä¸­ï¼Œ 
å¹¶å°†`has`å¯¹è±¡ä¸­`id`å¯¹åº”çš„å€¼è®¾ä¸º`true`, ä»¥é˜²æ­¢é‡å¤åŠ å…¥é˜Ÿåˆ—

å¹¶ä¸”åˆ¤æ–­ä¸€ä¸‹`waiting`ï¼Œå¾—çŸ¥å½“å‰æ˜¯å¦å¤„äºç­‰å¾…çŠ¶æ€ï¼Œ å¦‚æœä¸æ˜¯ï¼Œ å°±å°†`waiting`æ”¹ä¸º`true`, ç„¶åå°±æ˜¯åˆ¤æ–­å½“å‰æµè§ˆå™¨çš„æ”¯æŒæƒ…å†µï¼Œ å°†å¤„ç†çš„ä»»åŠ¡æ‰”åˆ°å¼‚æ­¥é˜Ÿåˆ—ä¸­ï¼Œ

å®ƒè¿™é‡Œè¿™ä¹ˆåšæ˜¯ä¸ºäº†ï¼Œåªæ‰¹å¤„ç†ä¸€æ¬¡ï¼Œ ä½ ä¸€ç¬é—´åŠ å…¥å¤šä¸ª`watcher`, å¾ˆå®¹æ˜“é€ æˆé‡å¤æ‰§è¡Œï¼Œ åˆ©ç”¨`Watcher`çš„`id`æ¥è¿‡æ»¤ï¼Œ å¹¶ä¸”åˆ©ç”¨å¼‚æ­¥ï¼Œ ç­‰ä½ è¦åŠ çš„`watcher`éƒ½åŠ å®Œäº†ï¼Œ æˆ‘å†ç»™ä½ ç»Ÿä¸€çš„å»æ‰§è¡Œæ‰€æœ‰`Watcher`

ä¹Ÿå°±æ˜¯å¼‚æ­¥ä»»åŠ¡ç»“æŸåè°ƒç”¨çš„`flush`æ–¹æ³•ï¼Œ å®ƒåœ¨å†…éƒ¨ä¼šéå†`queue`é˜Ÿåˆ—ï¼Œ æŒ¨ä¸ªçš„è°ƒç”¨`Watcher`çš„`cb`æ–¹æ³•
åœ¨è¿™ä¸€åˆ‡éƒ½æ‰§è¡Œå®Œæˆä¹‹åï¼Œ åˆè°ƒç”¨äº†ä¸€æ¬¡`reset`æ–¹æ³•ï¼Œ å°†`bascher`çš„ä¸‰ä¸ªå±æ€§é‡ç½®ä¸ºåˆå§‹çŠ¶æ€

æ­¤æ—¶å…³æ³¨ç‚¹åˆå›åˆ°äº†`Watcher`èº«ä¸Šï¼Œ å®ƒçš„`cb`æ–¹æ³•åˆåšäº†ä»€ä¹ˆ
```JavaScript
Watcher.prototype = {
  // ...çœç•¥å…¶ä»–æ–¹æ³•

  // ç»™domèµ‹å€¼
  cb() {
    // æœ€ç»ˆå®é™…è™šæ‹Ÿdom å¤„ç†ç»“æœï¼Œ åªå¤„ç†ä¸€æ¬¡
    // è™šæ‹Ÿdom -> diff( è™šæ‹Ÿdom ) -> å±€éƒ¨æ›´æ–° -> createElement(vNode) -> render
    this.node[this.type] = this.value
  },
}
```

å¯ä»¥çœ‹åˆ°`cb`æ–¹æ³•åšçš„äº‹æƒ…å¾ˆç®€å•é‚£ï¼Œ å°±æ˜¯**æ ¹æ®å…ƒç´ çš„å€¼ç±»å‹å»ä¿®æ”¹å…ƒç´ å¯¹è±¡çš„å€¼**ï¼Œ è€Œè¿™ä¸ª`this.value`æ—©åœ¨ä¹‹å‰è°ƒç”¨ `Watcher`çš„`get`æ–¹æ³•æ—¶å°±è¢«èµ‹ä¸Šäº†

åˆ°è¿™é‡Œï¼Œæ•´ä¸ªæµç¨‹å°±èµ°å®Œäº†ï¼Œ ç›¸ä¿¡ä½ è¿˜æ˜¯ä¸€å¤´é›¾æ°´ï¼Œ æˆ‘ä»¬æŠŠæ•´ä¸ªæµç¨‹æ¥ä¸²ä¸€ä¸‹

1. new Vue
2. å°†`data`ä¸­çš„å€¼æŒ‚ä¸Š `getter`å’Œ`setter` çš„ç›¸åº”æ–¹æ³•ï¼Œ ç„¶åæš‚ä¸”æç½®ï¼Œå› ä¸ºæ­¤æ—¶è¿˜æ— äººè°ƒç”¨`getter`å’Œ`setter`
3. é€šè¿‡ `Compile`è§£ææ¨¡æ¿ï¼Œ æŒ¨ä¸ªé€’å½’`#app`ä¸‹çš„`dom`, åˆ¤æ–­å…ƒç´ ç±»å‹ï¼Œ å¦‚æœæ˜¯å…ƒç´ ï¼Œå¹¶ä¸”ä½¿ç”¨äº†`v-model`ï¼Œ å°±ç»‘å®šä¸€ä¸ª`input`äº‹ä»¶,  å¦‚æœæ˜¯æ–‡æœ¬ç±»å‹èŠ‚ç‚¹,å°±å»åŒ¹é…æ˜¯ä½¿ç”¨äº†`{{}}`è¯­æ³•ï¼Œ æœ€åä¸ºä»–ä»¬éƒ½åˆ›å»ºäº†ä¸€ä¸ª`watcher`
4. æ¯ä¸ª`watcher` ç”¨æ¥ä¿å­˜ç›¸å…³çš„å…ƒç´ å¯¹è±¡ï¼Œ `vm`å®ä¾‹ï¼Œä½¿ç”¨çš„`å˜é‡` ä»¥åŠå…ƒç´ å€¼ç±»å‹, å¹¶å°†è‡ªå·±çš„å®ä¾‹äº¤ç»™ï¼Œ `Dep.target`ï¼Œ å¹¶è§¦å‘è‡ªå·±çš„`update`æ–¹æ³•ï¼Œ`update`æ–¹æ³•åˆä¼šè°ƒç”¨`get`æ–¹æ³•ï¼Œ `get`æ–¹æ³•åˆä¼šè§¦å‘è¯¥å˜é‡çš„`getter`ï¼Œ è¿™ä¹Ÿå°±ä½¿å¾—`getter`ä¸­å¯ä»¥å°†è¯¥`watcher`æ”¾å…¥`dep`å®ä¾‹ä¸­ï¼Œ æœ€åå°†è‡ªå·±ä¹Ÿæ”¾å…¥`Bacher`ä¸­ï¼Œç”¨ä»¥æ‰¹å¤„ç†ä»¥åŠå°†`Dep.target`ç½®ç©º
5. `Batcher`æ˜¯ä¸ªå•ä¾‹ï¼Œ æ ¹æ®`Watcher`çš„`id`, å®ƒç”¨æ¥è¿‡æ»¤é‡å¤ä¼ å…¥çš„`Watcher`, ä¿è¯ä¸€ä¸ª`Watcher`åªè§¦å‘ä¸€æ¬¡, å¹¶å°†æ›´æ–°äº‹ä»¶ä¸¢å…¥å¼‚æ­¥ï¼Œç­‰å½“å‰çš„è¿ç»­æ“ä½œæ‰§è¡Œå®Œæˆåå»è°ƒç”¨`Watcher`çš„`cb`æ–¹æ³•æ›´æ–°`dom`
6. ä¹‹åç”¨æˆ·ä¿®æ”¹äº†å˜é‡, `setter`åˆä¼šè°ƒç”¨`dep`è¿™ä¸ªå‘å¸ƒè€…æ¥å‘å‡ºé€šçŸ¥ï¼Œ ç›¸å…³çš„`Watcher`çš„`update`æ–¹æ³•å†æ¬¡è¢«è°ƒç”¨ï¼Œ åˆä¼šåŠ å…¥`batcher` , `batcher`ç­‰å¾…å¼‚æ­¥å®Œæˆååˆè°ƒç”¨`Watcher`çš„`cb`æ–¹æ³•æ›´æ–°`dom`


**åˆ°è¿™é‡Œå°±æ•´ä¸ªä¸²å®Œäº†ï¼Œä½†æ˜¯æ„Ÿè§‰åºŸè¯è¿˜æ˜¯æœ‰ç‚¹å¤šï¼Œ å†ç®€åŒ–ä¸€ç‚¹æµç¨‹**:

new Vue --> `Observe` æŒ‚è½½ `setter` å’Œ `getter` -->  `Compile` ç¼–è¯‘æ¨¡æ¿ --> ä¸ºæ¯ä¸ªæŒ‡ä»¤åˆ†é…ä¸€ä¸ª`watcher` --> åˆ›å»ºæ—¶ä¼šè°ƒç”¨ä¸€æ¬¡`watcher.update` å°†è‡ªå·±åŠ å…¥åˆ°`batcher`çš„é˜Ÿåˆ— -->
å¹¶ä¸”æ­¤æ—¶ä¼šè§¦å‘ `getter` å°†`watcher`åŠ å…¥`dep` -->  `batcher` ç»Ÿä¸€æ¥å¤„ç†`watcher`ååˆå§‹åŒ–è‡ªå·± -->  å½“ç”¨æˆ·ä¿®æ”¹æŸä¸ªå˜é‡æ—¶ --> `dep`é€šçŸ¥`watcher` --> `watcher`åˆè¢«åŠ å…¥`batcher`å¤„ç† --> `watcher` æ›´æ–°`dom`


ğŸ˜•å¥½äº†ï¼Œ ç¥ç§˜çš„`Vue`æºç å·²è¢«æ­å¼€é¢çº±ï¼Œ ä½†è¿™ä»…ä»…æ˜¯ç®€æ˜“ç‰ˆçš„å®ç°ï¼Œ çœŸå®çš„`Vue`éå¸¸åºå¤§ï¼Œ è¿˜æœ‰æ›´å¤šçš„å†…å®¹ï¼Œ è¿™é‡Œåªæ˜¯è®©å¤§å®¶æ˜ç™½`MVVM`çš„æ ¸å¿ƒåŸç†


é¡¹ç›®æºç :
> https://github.com/nxl3477/note/tree/master/Javascript/Vue/%E5%AE%9E%E7%8E%B0vue

ä¼˜è´¨æ–‡çŒ®: 
* [æ±¤å§†å¤§å”çš„è§‚å¯Ÿè€…æ¨¡å¼](http://www.cnblogs.com/TomXu/archive/2012/03/02/2355128.html)