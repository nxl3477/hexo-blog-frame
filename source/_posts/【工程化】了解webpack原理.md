---
title: ã€å·¥ç¨‹åŒ–ã€‘äº†è§£webpackåŸç†
date: 2019-07-11 22:58:30
categories: å·¥ç¨‹åŒ–
tags:  [webpack, å·¥ç¨‹åŒ–, Ast]
---


> webpack çš„æˆåŠŸä¹‹å¤„åœ¨äºå…¶loader , ä½† webpack çš„å¤±è´¥ä¹‹å¤„ä¹Ÿå‡ºåœ¨è¿™ä¸ªloader

å¯¹äºwebpack æ¥è®²ï¼Œ ä¸‡ç‰©éƒ½æ˜¯æ¨¡å—ï¼Œ webpack ä¸ºä»€ä¹ˆå¯ä»¥åšåˆ°ä¸‡ç‰©éƒ½å¯ä»¥ `require`å°±æ˜¯ä½¿ç”¨äº†loader,  ä½†åŒæ—¶ä¹Ÿæ˜¯loader å¯¼è‡´äº†webpack çš„ç¼–è¯‘é€Ÿåº¦ï¼ˆä½ æ‡‚çš„ï¼‰ï¼Œ è¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Œ è¿™é‡Œå…ˆè¯´ä¸€ä¸‹åŸºæœ¬åŸç†
***

webpack åœ¨å¤„ç†çš„æ—¶å€™ï¼Œ ä¼šç»è¿‡å¤šä¸ªloader, æ¯”å¦‚`babel-loader`,`less-loader`ï¼Œ é‚£å¦‚ä½•æŠŠè¿™äº›çœ‹ä¼¼æ¯«ä¸ç›¸å…³çš„ï¼Œ åˆæ˜¯å¤©å—åœ°åŒ—æ‰¾æ¥çš„ï¼Œ å‡ºè‡ªä¸åŒå¼€å‘è€…ä¹‹æ‰‹çš„loader é›†åˆèµ·æ¥å‘¢:

é¦–å…ˆæ˜¯ç¬¬ä¸€ä¸ªæ¥å—ä»»åŠ¡çš„loader, loader1 ä¼šæ¥å—ä»£ç çš„å­—ç¬¦ä¸²ï¼Œ ç„¶åæŠŠä»£ç å˜æˆ Ast è¿›è¡Œå¤„ç†ï¼Œ ç»“æŸä»¥åå†è½¬ä¸º stringå­—ç¬¦ä¸²ã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼Œæ•´ä¸ª loader1 ç»å†äº†ä¸€ä¸‹çš„æµç¨‹:

```
å­—ç¬¦ä¸² -> Ast é™æ€è¯­æ³•æ ‘ -> éå†Astå¤„ç†ä¸šåŠ¡ -> å­—ç¬¦ä¸²
```

åŒæ ·çš„loader2 ä¹Ÿä¼šç»å†è¿™æ ·ä¸€ä¸ªè¿‡ç¨‹ï¼


ä¹Ÿå°±æ˜¯è¯´æ‰€æœ‰loader ç©¿èµ·æ¥å°±æ˜¯:
```
loader1 å¼€å§‹ -> è·å–å­—ç¬¦ä¸² ->  Ast -> éå†Astå¤„ç†ä¸šåŠ¡ 
-> å­—ç¬¦ä¸² -> loader1ç»“æŸ -> loader2 å¼€å§‹ -> è·å¾—å­—ç¬¦ä¸² 
-> Ast -> éå†Astå¤„ç†ä¸šåŠ¡ -> å­—ç¬¦ä¸² -> loader 2 ç»“æŸ 
-> loader3å¼€å§‹ -> â€¦â€¦â€¦ç­‰ç­‰
```

ä¹ä¸€çœ‹ï¼Œ ä½ å¯èƒ½ä¼šè§‰å¾—ï¼Œ æ˜¯ä¸æ˜¯å¤ªè ¢äº†ï¼Œ ä¸ºä»€ä¹ˆä¸ç­‰åˆ°å…¨éƒ¨loaderå¤„ç†å®Œæˆå†è½¬æ¢å› å­—ç¬¦ä¸²ï¼Œ è¿˜è¦è½¬æ¥è½¬å»ï¼Œ åŸæ¥æ‰“åŒ…æ—¶é—´éƒ½åœ¨è¿™æ¶ˆè€—æ‰äº†ã€‚
æ²¡é”™ï¼Œ ä½ å½“ç„¶ä¸æ˜¯ç¬¬ä¸€ä¸ªæƒ³åˆ°çš„ï¼Œ è¿™å°±æ˜¯ä¹‹å‰å¤§ç«çš„parcel çš„æ‰“åŒ…æœºåˆ¶ï¼ˆè™½ç„¶parcelçš„é›¶é…ç½®å¾ˆä¼˜ç§€ï¼Œ ä½†å› ä¸ºè¢«webpackæŠ„èµ°äº†ï¼Œ æ‰€ä»¥ä¹Ÿæ¸æ¸åŠ¿å¤´ä¸åœ¨ï¼‰,  å¹¶ä¸”parcelè¿˜å¯ç”¨äº†å¤šæ ¸æ‰“åŒ…:

```
stringå­—ç¬¦ä¸² -> Ast(loader1 & loader2 & loader3) -> string å­—ç¬¦ä¸²  å¤–åŠ å¤šæ ¸æ‰“åŒ…ğŸ“¦
```

ä¸€æ°”å‘µæˆï¼Œ è¿™æ„Ÿè§‰ï¼Œå¤šçˆ½ï¼Œ ç¡®å®æ¯”webpackå¿«å¤šäº† ï¼Œçœäº†é‚£ä¹ˆå¤šæ­¥éª¤ï¼Œ èƒ½ä¸å¿«å—


## webpack ä¸ä¼˜åŒ–
ä¸Šé¢æåˆ°äº† parcel çš„å¤šæ ¸æ‰“åŒ…ï¼Œ å¯æˆ‘ä»¬çš„ä¸»åœºæ˜¯webpack ,æ€ä¹ˆèƒ½ä¸æä¸€æwebpack çš„å¤šæ ¸æ‰“åŒ…å‘¢ï¼Œ 

ç›¸ä¿¡å¤§å®¶éƒ½å¬è¿‡æˆ–è€…å°è¯•è¿‡è‡­åæ˜­è‘—çš„ `happypack` å¤šæ ¸æ‰“åŒ…æ’ä»¶ï¼Œ ä½†è¿™ä¸ªæ’ä»¶å®é™…ä¸Šåœ¨é«˜ç‰ˆæœ¬çš„webpack ä¸Šæ•ˆæœç•¥ä½å•Š

happypack å¯ä»¥ç”¨ï¼Œä½†ä¹Ÿéœ€è¦è€ƒè™‘ä¸‹åº”ç”¨åœºæ™¯ï¼š åœ¨éœ€è¦æ‰“åŒ…çš„æ–‡ä»¶å¤ªå°‘ä¸å»ºè®®ï¼Œ å› ä¸ºå¤šæ ¸æ‰“åŒ…ä¹Ÿæ˜¯éœ€è¦æ¶ˆè€—ç³»ç»Ÿæ€§èƒ½çš„ï¼Œ åè€Œä¼šä½¿æ‰“åŒ…å˜æ…¢äº†

å®é™…æ“ä½œèµ·æ¥æ•ˆæœä¸æ˜æ˜¾


## å¦‚ä½•å®ç°ä¸€ä¸ªloader

 ç†Ÿè¯è¯´ï¼Œ çœ‹æºç æ˜¯æœ€å¥½çš„å­¦ä¹ æ–¹å¼ï¼Œ ç°åœ¨æˆ‘ä»¬å…ˆæ‰¾ä¸€ä¸ªæ¯”è¾ƒç®€å•çš„å¼€æºloader ,çœ‹çœ‹åˆ«äººæ˜¯æ€ä¹ˆå†™çš„?
 
 æˆ‘ä»¬ä¸‹è½½`markdon-loader`, æ‰“å¼€node_modules ä¸­å…¶çš„ä»£ç ï¼Œ å‘ç°å¦‚ä¸‹ï¼š
 ![2019-09-14-19-30-43](http://img.nixiaolei.com/2019-09-14-19-30-43.png)


è®©æˆ‘ä»¬åŠ ç‚¹æ³¨é‡Šç†è§£ä¸€ä¸‹

![2019-09-14-19-34-46](http://img.nixiaolei.com/2019-09-14-19-34-46.png)


loader æœ‰ä¸€ä¸ªå‰ç½®é’©å­ï¼Œ ä¼šåœ¨è¿›å…¥ä¸»ä½“å‡½æ•°å‰è¢«è°ƒç”¨ï¼š

```js
module.exports = function (content, map, meta) {
  //  this æ˜¯æˆ‘ä»¬è¿è¡Œæ—¶æ•°æ®è°ƒç”¨æ–¹æ³•å’Œè¡¥å……è½½ä½“ ä¹Ÿå°±æ˜¯loaderå‡½æ•°çš„æ‰§è¡Œä¸Šä¸‹æ–‡ï¼Œ æ‰€ä»¥å¯ä»¥é€šè¿‡webpack æä¾›çš„å‡½
  // æ•°åº“æ¥ä» this è·å–å¤–éƒ¨ rule å¤„å¯¹ loader é…ç½®çš„option

  console.log('ğŸè¿›å…¥loader')
  console.log('å‰ç½®é’©å­å†…å®¹ğŸŒ', this.data)
  return content + ";console.log(1)"
}

// ä¸€ä¸ªå«pitchçš„å‰ç½®é’©å­ ( åœ¨è¿›å…¥â¬†ï¸ä¸»ä½“å‰è§¦å‘)
module.exports.pitch = function (r, prerequest, data) {
  console.log("è¿›å…¥å‰ç½®é’©å­")
  data.value = "are you ok"
}
```

åœ¨å¤–é¢webpack é…ç½®çš„åœ°æ–¹å¼•ç”¨æˆ‘ä»¬ä¸Šæ–¹ç¼–å†™çš„loader
```js
const path = require('path')

module.exports = {
  module: {
    rules: [
      {
        test: /\.js$/,
        exclude: /(node_modules|bower_components)/,
        use: {
          loader: path.resolve("./loader/index.js"),
          options: {
            presets: ['@babel/preset-env']
          }
        }
      }
    ]
  }
}
```


è®©æˆ‘ä»¬çœ‹ä¸‹æ­¤æ—¶çš„è¾“å‡ºç»“æœ
![2019-09-14-20-18-39](http://img.nixiaolei.com/2019-09-14-20-18-39.png)


#### è·å–ç›¸å…³çš„option é…ç½®
webpack æä¾›çš„å‡½æ•°åº“å¯ä»¥å¸®åŠ©æˆ‘ä»¬ï¼Œ åœ¨æ‰§è¡Œé˜¶æ®µä» this å¯¹è±¡ä¸Šè·å–åˆ°æˆ‘ä»¬é…ç½®æ—¶æ‰€ä¼ å…¥çš„ option çš„ç›¸å…³ loader  é…ç½®
```js
const loaderUtils = require('loader-utils')

module.exports = function (content, map, meta) {
  //  this æ˜¯æˆ‘ä»¬è¿è¡Œæ—¶æ•°æ®è°ƒç”¨æ–¹æ³•å’Œè¡¥å……è½½ä½“ ä¹Ÿå°±æ˜¯loaderå‡½æ•°çš„æ‰§è¡Œä¸Šä¸‹æ–‡ï¼Œ æ‰€ä»¥å¯ä»¥é€šè¿‡webpack æä¾›çš„å‡½
  // æ•°åº“æ¥ä» this è·å–å¤–éƒ¨ rule å¤„å¯¹ loader é…ç½®çš„option

  console.log('ğŸè¿›å…¥loader')
  console.log('å‰ç½®é’©å­å†…å®¹ğŸŒ', this.data)
  const options = loaderUtils.getOptions(this)
  console.log('ğŸŠè·å–åˆ°çš„é…ç½®æ–‡ä»¶', options)
  return content + ";console.log(1)"
}

// ä¸€ä¸ªå«pitchçš„å‰ç½®é’©å­ ( åœ¨è¿›å…¥â¬†ï¸ä¸»ä½“å‰è§¦å‘)
module.exports.pitch = function (r, prerequest, data) {
  console.log("è¿›å…¥å‰ç½®é’©å­")
  data.value = "are you ok"
}
```


æ­¤æ—¶æˆ‘ä»¬å°±æˆåŠŸè·å–åˆ°äº†é…ç½®æ—¶æ‰€ä¼ å…¥çš„å‚æ•°äº†

![2019-09-14-20-24-56](http://img.nixiaolei.com/2019-09-14-20-24-56.png)

#### å¼‚æ­¥loader
å¦‚æœæˆ‘ä»¬çš„ç¼–å†™è¿‡ç¨‹ä¸­æœ‰å¼‚æ­¥çš„éœ€æ±‚, æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸‹é¢è¿™ä¸¤ä¸ªæ–¹æ³•

* this.async æ‰§è¡Œå¼‚æ­¥å‡½æ•°
* this.callback æ‰§è¡Œå‡½æ•°çš„å›è°ƒï¼Œ è¿”å›å¤„ç†ç»“æœ



## loader  ä¸ Ast
æ—¢ç„¶loaderå¤„ç†çš„æ ¸å¿ƒæ˜¯ Ast, é‚£ä¹ˆæˆ‘ä»¬åŒæ ·çš„å¤œæ¥å°è¯•ä¸€ä¸‹Ast çš„ä½¿ç”¨,

é¦–å…ˆæˆ‘ä»¬ä¸‹è½½ä¸€ä¸ª`acorn` , è¿™æ˜¯ä¸€ä¸ªä¸“é—¨å¤„ç† ast çš„åº“, æˆ‘ä»¬ä½¿ç”¨ acorn æä¾›çš„æ–¹æ³•å°è¯•å»è½¬æ¢ä¸€æ®µä»£ç ï¼Œ ç„¶åä½¿ç”¨walk æ‰€æä¾›çš„æ–¹æ³•å°†å…¶è½¬æ¢å›æ¥
```JS
const acorn = require("acorn")
const walk = require('acorn-walk')

console.log(acorn.parse("const a = 20"))
walk.simple(acorn.parse('let x = 10'), {
  Literal(node) {
    console.log(`Found a literal: ${node.value}`)
  }
})
```

è¾“å‡ºçš„ç»“æœ

![2019-09-14-21-07-23](http://img.nixiaolei.com/2019-09-14-21-07-23.png)

